<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>REDHOSTING</title>
    <script src="/socket.io/socket.io.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;600&display=swap" rel="stylesheet">
    <style>
        /* [ESTILOS OMITIDOS POR REPETI√á√ÉO, MANTER OS ESTILOS ORIGINAIS] */
        /* --- ESTILOS ADICIONAIS NECESS√ÅRIOS --- */
        .bot-list { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .bot-card { 
            background: #1a1a1a; border: 1px solid #333; padding: 15px; 
            border-radius: 8px; cursor: pointer; transition: 0.2s; text-align: center;
        }
        .bot-card:hover { border-color: var(--primary); transform: translateY(-2px); background: #222; }
        .bot-card h3 { margin-bottom: 5px; color: #fff; }
        .bot-card p { font-size: 0.8rem; color: #888; }
        .bot-icon { font-size: 2rem; margin-bottom: 10px; display: block; }
    </style>
</head>
<body>

    <header>
        <div class="brand">REDHOSTING</div>
        <div class="header-actions">
            <button class="btn-icon" onclick="reloadTerminalLogs()">REINICIAR</button>
            
            <button class="btn-icon btn-icon-svg" onclick="toggleModal(true)">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
            </button>
        </div>
    </header>

    <div class="terminal" id="terminal">
        <div class="log type-info">-- RED SYSTEM READY --</div>
        <div class="log type-warn">Aguardando conex√£o...</div>
    </div>

    <div class="input-area">
        <input type="text" id="cmdInput" placeholder="Comando..." autocomplete="off">
        <button class="btn-send" onclick="sendCommand()">></button>
    </div>

    <div class="modal-overlay" id="modalOverlay">
        <div class="modal">
            <div class="modal-header">
                <h3>CONFIGURA√á√ÉO</h3>
                <span class="close-btn" onclick="toggleModal(false)">&times;</span>
            </div>
            
            <div class="tabs">
                <div class="tab active" onclick="setTab('bots', this)">BOTS PRONTOS</div>
                <div class="tab" onclick="setTab('git', this)">CUSTOMIZADO</div>
                <div class="tab" onclick="setTab('files', this)">ARQUIVOS</div>
            </div>

            <div id="panel-bots" class="content-area show">
                <h4 style="margin-bottom:15px; color:#aaa;">Selecione um bot para instalar automaticamente:</h4>
                <div class="bot-list">
                    <div class="bot-card" onclick="deployPreset('https://github.com/bronxys/Black.git', 'Black')">
                        <span class="bot-icon">üï∑Ô∏è</span>
                        <h3>BLACK</h3>
                        <p>Bot completo e vers√°til.</p>
                    </div>

                    <div class="bot-card" onclick="deployPreset('https://github.com/bronxys/Nazuna.git', 'Nazuna')">
                        <span class="bot-icon">üå∏</span>
                        <h3>NAZUNA</h3>
                        <p>Bot focado em intera√ß√£o.</p>
                    </div>
                </div>
                <p style="margin-top:20px; font-size:0.8rem; color:#666; text-align:center;">
                    ‚ö†Ô∏è O bot atual ser√° **apagado** e o novo ser√° instalado.
                </p>
            </div>

            <div id="panel-git" class="content-area">
                <div class="form-group">
                    <label class="form-label">Reposit√≥rio URL</label>
                    <input type="text" id="gitUrl" placeholder="https://github.com/usuario/repo.git" class="form-input">
                </div>
                <div class="form-group">
                    <label class="form-label">Comando de In√≠cio</label>
                    <input type="text" id="gitCmd" value="node index.js" class="form-input">
                </div>
                <div class="checkbox-wrapper">
                    <input type="checkbox" id="gitDeps" checked>
                    <label>Rodar 'npm install'</label>
                </div>
                <button class="btn-full" onclick="deployGit()">CLONE & START</button>
            </div>

            <div id="panel-files" class="content-area">
                <div class="file-list-header">Caminho Atual: <span id="currentPathDisplay">/</span></div>
                <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                    <button class="btn-full" style="background:#333; color:#fff; flex:1" onclick="refreshFiles()">ATUALIZAR</button>
                    <input type="file" id="uploadSingle" style="display:none" onchange="uploadSingleFile(this)">
                    <button class="btn-full" style="background:#555; color:#fff; flex:1" onclick="document.getElementById('uploadSingle').click()">UPLOAD</button>
                </div>
                
                <div id="fileListContainer" style="overflow-y: auto;"></div>
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        const terminal = document.getElementById('terminal');
        let currentPath = '/';
        
        // --- LOGS E COMANDOS (MANTIDOS) ---
        socket.on('log-history', (history) => {
            terminal.innerHTML = '';
            history.forEach(addLogToScreen);
        });
        socket.on('log-message', addLogToScreen);

        function addLogToScreen(data) {
            const div = document.createElement('div');
            div.className = `log type-${data.type}`;
            div.innerHTML = `<span class="ts">${data.time}</span>${data.text}`;
            terminal.appendChild(div);
            terminal.scrollTop = terminal.scrollHeight;
        }
        
        // Fun√ß√£o do Bot√£o REINICIAR: Pede ao servidor o hist√≥rico novamente
        function reloadTerminalLogs() {
            terminal.innerHTML = ''; 
            addLogToScreen({ type: 'info', text: '-- REINICIANDO LOG DO PAINEL --', time: new Date().toLocaleTimeString('pt-BR') });
            socket.emit('request-log-history'); 
        }

        function sendCommand() {
            const input = document.getElementById('cmdInput');
            const cmd = input.value.trim();
            if(cmd) {
                socket.emit('terminal-input', cmd);
                input.value = '';
            }
        }
        document.getElementById('cmdInput').addEventListener('keypress', (e) => {
            if(e.key === 'Enter') sendCommand();
        });

        // --- UI LOGIC (MANTIDA) ---
        function toggleModal(show) {
            document.getElementById('modalOverlay').style.display = show ? 'flex' : 'none';
            if(show && document.querySelector('.tab.active').innerText.includes('ARQUIVOS')) refreshFiles();
        }

        function setTab(id, el) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.content-area').forEach(c => c.classList.remove('show'));
            el.classList.add('active');
            document.getElementById(`panel-${id}`).classList.add('show');
            if(id === 'files') refreshFiles();
        }

        // --- DEPLOY LOGIC ---
        
        // NOVO: DEPLOY PARA BOTS PRONTOS
        function deployPreset(url, name) {
            if(!confirm(`Tem certeza que deseja apagar tudo e instalar o ${name}?`)) return;
            
            toggleModal(false);
            
            fetch('/deploy/git', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    repoUrl: url,
                    installDeps: true, // Sempre instala dependencias para bots prontos
                    startCommand: '' // Deixa o backend decidir
                })
            });
        }
        
        // DEPLOY GIT CUSTOM (MANTIDA)
        async function deployGit() {
            const body = JSON.stringify({
                repoUrl: document.getElementById('gitUrl').value,
                startCommand: document.getElementById('gitCmd').value,
                installDeps: document.getElementById('gitDeps').checked
            });

            toggleModal(false);
            await fetch('/deploy/git', { 
                method: 'POST', 
                headers: {'Content-Type': 'application/json'},
                body: body
            });
        }
        
        // --- FUN√á√ïES DE ARQUIVOS (MANTIDAS) ---
        // Fun√ß√µes changePath, renderPathDisplay, refreshFiles, deleteFile, uploadSingleFile
        // (Assumimos que voc√™ as manteve no seu HTML original, pois s√£o longas)
        function changePath(newSegment) {
            if (newSegment === '..') {
                const pathSegments = currentPath.split('/').filter(s => s.length > 0);
                pathSegments.pop(); 
                currentPath = pathSegments.length === 0 ? '/' : '/' + pathSegments.join('/') + '/';
            } else if (newSegment === '/') {
                currentPath = '/';
            } else {
                currentPath = currentPath.endsWith('/') ? currentPath + newSegment + '/' : currentPath + '/' + newSegment + '/';
            }
            currentPath = '/' + currentPath.replace(/^\/|\/$/g, '').replace(/\/\//g, '/') + '/';
            if (currentPath === '//') currentPath = '/';
            refreshFiles();
        }

        function renderPathDisplay() {
            document.getElementById('currentPathDisplay').innerText = '/user_bot' + currentPath;
        }

        async function refreshFiles() {
            const container = document.getElementById('fileListContainer');
            renderPathDisplay();
            container.innerHTML = 'Buscando arquivos...';
            
            try {
                const res = await fetch(`/files/list?path=${encodeURIComponent(currentPath)}`);
                let files;
                
                if (res.ok) {
                    files = await res.json();
                } else {
                    const errorData = await res.json();
                    throw new Error(errorData.error || `Erro HTTP: ${res.status}`);
                }

                container.innerHTML = '';
                
                if (currentPath !== '/') {
                    const backDiv = document.createElement('div');
                    backDiv.className = 'file-item';
                    backDiv.onclick = () => changePath('..');
                    backDiv.innerHTML = `<div class="file-name"><span class="icon-up">‚¨ÜÔ∏è</span> ..</div><div class="file-size"></div><div class="file-actions"></div>`;
                    container.appendChild(backDiv);
                }

                files.forEach(f => {
                    const isDir = f.isDir;
                    const div = document.createElement('div');
                    div.className = 'file-item';
                    
                    if (isDir) {
                        div.onclick = () => changePath(f.name);
                        div.innerHTML = `
                            <div class="file-name"><span class="icon-dir">üìÅ</span> ${f.name}</div>
                            <div class="file-size">-</div>
                            <div class="file-actions">
                                <button onclick="event.stopPropagation(); deleteFile('${f.name}')">Del</button>
                            </div>
                        `;
                    } else {
                        div.onclick = () => {}; 
                        div.innerHTML = `
                            <div class="file-name">üìÑ ${f.name}</div>
                            <div class="file-size">${f.size}</div>
                            <div class="file-actions">
                                <button onclick="event.stopPropagation(); deleteFile('${f.name}')">Del</button>
                            </div>
                        `;
                    }
                    container.appendChild(div);
                });

                if(files.length === 0 && currentPath === '/') {
                    container.innerHTML += '<div style="text-align:center; color:#666; margin-top:20px;">Pasta raiz vazia</div>';
                }

            } catch(e) {
                container.innerHTML = `<div style="color:red; text-align:center;">Erro ao carregar lista. ${e.message}</div>`;
            }
        }

        async function deleteFile(name) {
            if(!confirm(`Deletar ${currentPath}${name}?`)) return;
            
            await fetch('/files/delete', {
                method: 'DELETE', 
                headers: {'Content-Type':'application/json'}, 
                body: JSON.stringify({ name: name, currentPath: currentPath })
            });
            refreshFiles();
        }

        async function uploadSingleFile(input) {
            const file = input.files[0];
            if(!file) return;

            const formData = new FormData();
            formData.append('file', file);
            formData.append('currentPath', currentPath); 

            await fetch('/files/upload', { method: 'POST', body: formData });
            input.value = ''; 
            refreshFiles(); 
        }
        
    </script>
</body>
</html>
