<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RED PROTOCOL /// MOBILE</title>
    <script src="/socket.io/socket.io.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;600&display=swap" rel="stylesheet">
    <style>
        /* --- VARIAVEIS E RESET --- */
        :root {
            --bg: #050505; --panel: #0f0f0f;
            --primary: #ff0033; --dim: #661122;
            --text: #eee; --gray: #666;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; }
        
        body { 
            background: var(--bg); color: var(--text); 
            font-family: 'Fira Code', monospace; 
            height: 100vh; height: 100dvh; /* Mobile fix */
            display: flex; flex-direction: column; 
            overflow: hidden;
        }

        /* GRID EFFECT */
        body::before {
            content: ""; position: absolute; inset: 0;
            background: linear-gradient(transparent 95%, var(--dim) 100%), linear-gradient(90deg, transparent 95%, var(--dim) 100%);
            background-size: 20px 20px; opacity: 0.1; z-index: -1; pointer-events: none;
        }

        /* HEADER */
        header {
            height: 55px; background: var(--panel);
            border-bottom: 2px solid var(--primary);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 15px; z-index: 10;
            box-shadow: 0 2px 15px rgba(255, 0, 51, 0.15);
        }
        .brand { font-weight: 700; color: var(--primary); font-size: 1rem; letter-spacing: 1px; }
        .status { font-size: 0.7rem; color: var(--gray); margin-left: 5px; }

        .btn-icon {
            background: none; border: 1px solid var(--primary);
            color: var(--primary); padding: 6px; border-radius: 4px;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
        }
        .btn-icon:active { background: var(--primary); color: #000; }

        /* TERMINAL AREA */
        .terminal {
            flex: 1; background: rgba(0,0,0,0.3);
            padding: 10px; overflow-y: auto; overflow-x: hidden;
            font-size: 0.85rem; display: flex; flex-direction: column;
        }
        .log { 
            margin-bottom: 6px; word-wrap: break-word; line-height: 1.4; 
            border-left: 2px solid transparent; padding-left: 5px;
        }
        .ts { color: var(--gray); font-size: 0.7rem; margin-right: 5px; display: inline-block; min-width: 60px;}
        
        .log.type-info { border-color: #444; }
        .log.type-error { color: #ff4444; border-color: #ff0000; background: rgba(255,0,0,0.05); }
        .log.type-success { color: #00ff66; border-color: #00ff66; }
        .log.type-warn { color: #ffcc00; }
        .log.type-input { color: #888; font-style: italic; }

        /* INPUT BAR */
        .input-area {
            background: var(--panel); padding: 10px;
            border-top: 1px solid #333; display: flex; gap: 10px;
        }
        #cmdInput {
            flex: 1; background: #000; border: 1px solid #333;
            color: var(--primary); padding: 10px; border-radius: 4px;
            font-family: inherit; font-size: 1rem; /* Prevents zoom on iOS */
        }
        #cmdInput:focus { border-color: var(--primary); }
        
        .btn-send {
            background: var(--primary); color: #000; border: none;
            padding: 0 15px; font-weight: bold; border-radius: 4px; cursor: pointer;
        }

        /* MODAL (FULLSCREEN ON MOBILE) */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.9);
            backdrop-filter: blur(5px); z-index: 100;
            display: none; justify-content: center; align-items: center;
        }
        .modal {
            width: 95%; max-width: 600px; max-height: 90vh;
            background: #111; border: 1px solid var(--primary);
            display: flex; flex-direction: column;
            box-shadow: 0 0 30px rgba(255, 0, 51, 0.2);
            border-radius: 6px; overflow: hidden;
        }
        .modal-header {
            padding: 15px; background: #1a1a1a; border-bottom: 1px solid #333;
            display: flex; justify-content: space-between; align-items: center;
        }
        .close-btn { font-size: 1.5rem; color: #fff; cursor: pointer; padding: 0 10px; }

        /* TABS */
        .tabs { display: flex; background: #000; border-bottom: 1px solid #333; }
        .tab {
            flex: 1; text-align: center; padding: 12px; color: #666;
            border-bottom: 2px solid transparent; cursor: pointer; font-size: 0.9rem;
        }
        .tab.active { color: var(--primary); border-bottom-color: var(--primary); background: rgba(255,0,51,0.05); }

        /* CONTENT AREAS */
        .content-area { padding: 15px; overflow-y: auto; display: none; }
        .content-area.show { display: block; }
        
        .form-group { margin-bottom: 15px; }
        .form-label { display: block; color: #aaa; margin-bottom: 5px; font-size: 0.8rem; }
        .form-input {
            width: 100%; padding: 12px; background: #000; border: 1px solid #333;
            color: #fff; border-radius: 4px; font-family: inherit;
        }
        .checkbox-wrapper { display: flex; align-items: center; gap: 10px; margin: 15px 0; }
        .checkbox-wrapper input { width: 20px; height: 20px; accent-color: var(--primary); }
        
        .btn-full {
            width: 100%; padding: 14px; background: var(--primary);
            color: #000; border: none; font-weight: bold; border-radius: 4px;
            font-size: 1rem; cursor: pointer; margin-top: 10px;
        }
        
        /* FILE LIST */
        .file-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px; border-bottom: 1px solid #222;
        }
        .file-name { color: #ddd; font-size: 0.9rem; overflow: hidden; text-overflow: ellipsis; }
        .file-actions button {
            background: none; border: 1px solid #333; color: #ff4444;
            padding: 5px 10px; border-radius: 4px; margin-left: 5px;
        }

    </style>
</head>
<body>

    <header>
        <div class="brand">RED PROTOCOL <span class="status">v5.0</span></div>
        <button class="btn-icon" onclick="toggleModal(true)">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
        </button>
    </header>

    <div class="terminal" id="terminal">
        <div class="log type-info">-- RED PROTOCOL SYSTEM READY --</div>
        <div class="log type-warn">Aguardando conexão...</div>
    </div>

    <div class="input-area">
        <input type="text" id="cmdInput" placeholder="Comando..." autocomplete="off">
        <button class="btn-send" onclick="sendCommand()">></button>
    </div>

    <div class="modal-overlay" id="modalOverlay">
        <div class="modal">
            <div class="modal-header">
                <h3>CONFIGURAÇÃO</h3>
                <span class="close-btn" onclick="toggleModal(false)">&times;</span>
            </div>
            
            <div class="tabs">
                <div class="tab active" onclick="setTab('zip', this)">ZIP</div>
                <div class="tab" onclick="setTab('git', this)">GIT</div>
                <div class="tab" onclick="setTab('files', this)">ARQUIVOS</div>
            </div>

            <div id="panel-zip" class="content-area show">
                <div class="form-group">
                    <label class="form-label">Arquivo ZIP</label>
                    <input type="file" id="zipFile" class="form-input" accept=".zip" style="padding:8px">
                </div>
                <div class="form-group">
                    <label class="form-label">Comando de Início</label>
                    <input type="text" id="zipCmd" value="node index.js" class="form-input">
                </div>
                <div class="checkbox-wrapper">
                    <input type="checkbox" id="zipDeps" checked>
                    <label>Rodar 'npm install'</label>
                </div>
                <button class="btn-full" onclick="deployZip()">UPLOAD & START</button>
            </div>

            <div id="panel-git" class="content-area">
                <div class="form-group">
                    <label class="form-label">Repositório URL</label>
                    <input type="text" id="gitUrl" placeholder="https://github.com/user/repo" class="form-input">
                </div>
                <div class="form-group">
                    <label class="form-label">Comando de Início</label>
                    <input type="text" id="gitCmd" value="node index.js" class="form-input">
                </div>
                <div class="checkbox-wrapper">
                    <input type="checkbox" id="gitDeps" checked>
                    <label>Rodar 'npm install'</label>
                </div>
                <button class="btn-full" onclick="deployGit()">CLONE & START</button>
            </div>

            <div id="panel-files" class="content-area">
                <button class="btn-full" style="background:#333; color:#fff; margin-bottom:15px" onclick="refreshFiles()">ATUALIZAR LISTA</button>
                <div id="fileListContainer">Carregando...</div>
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        const terminal = document.getElementById('terminal');
        
        // --- SOCKET EVENTS ---
        
        socket.on('log-history', (history) => {
            terminal.innerHTML = ''; // Limpa para evitar duplicados
            history.forEach(addLogToScreen);
        });

        socket.on('log-message', (data) => {
            addLogToScreen(data);
        });

        function addLogToScreen(data) {
            const div = document.createElement('div');
            div.className = `log type-${data.type}`;
            div.innerHTML = `<span class="ts">${data.time}</span>${data.text}`;
            terminal.appendChild(div);
            // Auto scroll
            terminal.scrollTop = terminal.scrollHeight;
        }

        // --- COMMANDS ---
        function sendCommand() {
            const input = document.getElementById('cmdInput');
            const cmd = input.value.trim();
            if(cmd) {
                socket.emit('terminal-input', cmd);
                input.value = '';
            }
        }
        
        // Send on Enter key
        document.getElementById('cmdInput').addEventListener('keypress', (e) => {
            if(e.key === 'Enter') sendCommand();
        });

        // --- UI LOGIC ---
        function toggleModal(show) {
            document.getElementById('modalOverlay').style.display = show ? 'flex' : 'none';
            if(show && document.querySelector('.tab.active').innerText === 'ARQUIVOS') refreshFiles();
        }

        function setTab(id, el) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.content-area').forEach(c => c.classList.remove('show'));
            el.classList.add('active');
            document.getElementById(`panel-${id}`).classList.add('show');
            if(id === 'files') refreshFiles();
        }

        // --- DEPLOY LOGIC ---
        async function deployZip() {
            const file = document.getElementById('zipFile').files[0];
            if(!file) return alert("Selecione um ZIP!");
            
            const formData = new FormData();
            formData.append('file', file);
            formData.append('startCommand', document.getElementById('zipCmd').value);
            formData.append('installDeps', document.getElementById('zipDeps').checked);

            toggleModal(false);
            await fetch('/deploy/zip', { method: 'POST', body: formData });
        }

        async function deployGit() {
            const body = {
                repoUrl: document.getElementById('gitUrl').value,
                startCommand: document.getElementById('gitCmd').value,
                installDeps: document.getElementById('gitDeps').checked
            };
            toggleModal(false);
            await fetch('/deploy/git', { 
                method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body) 
            });
        }

        // --- FILES LOGIC ---
        async function refreshFiles() {
            const container = document.getElementById('fileListContainer');
            container.innerHTML = 'Buscando arquivos...';
            try {
                const res = await fetch('/files/list');
                const files = await res.json();
                
                if(files.length === 0) {
                    container.innerHTML = '<div style="text-align:center; color:#666">Pasta vazia</div>';
                    return;
                }

                container.innerHTML = '';
                files.forEach(f => {
                    const div = document.createElement('div');
                    div.className = 'file-item';
                    div.innerHTML = `
                        <div class="file-name" style="color:${f.isDir ? '#ffcc00' : '#ddd'}">
                            ${f.isDir ? '[DIR]' : ''} ${f.name}
                        </div>
                        <div class="file-actions">
                            <button onclick="deleteFile('${f.name}')">Del</button>
                        </div>
                    `;
                    container.appendChild(div);
                });
            } catch(e) {
                container.innerHTML = 'Erro ao carregar arquivos.';
            }
        }

        async function deleteFile(name) {
            if(!confirm('Deletar ' + name + '?')) return;
            await fetch('/files/delete', {
                method: 'DELETE', headers: {'Content-Type':'application/json'}, body: JSON.stringify({name})
            });
            refreshFiles();
        }
    </script>
</body>
</html>
